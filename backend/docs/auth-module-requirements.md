# 用户认证与登录模块需求文档

**文档版本**: 1.0  
**创建日期**: 2026-02-15  
**状态**: 待开发  
**优先级**: 高

---

## 1. 文档概述

### 1.1 目的

本文档旨在梳理 IP-NFT 平台用户认证与登录模块的功能现状，识别缺失功能，并提供详细的开发需求说明。

### 1.2 适用范围

- 前端开发团队
- 后端开发团队
- 产品经理
- 测试团队

### 1.3 术语定义

| 术语          | 说明                                       |
| ------------- | ------------------------------------------ |
| MFA           | Multi-Factor Authentication，多因素认证    |
| JWT           | JSON Web Token，用于认证的令牌             |
| Access Token  | 短期有效的访问令牌                         |
| Refresh Token | 长期有效的刷新令牌                         |
| 社交登录      | 使用第三方平台（如Google、GitHub）账号登录 |

---

## 2. 功能现状分析

### 2.1 已实现功能清单

#### 2.1.1 核心认证功能

| 功能项        | 实现状态  | 说明                                    |
| ------------- | --------- | --------------------------------------- |
| 邮箱/密码登录 | ✅ 已完成 | 支持邮箱+密码认证                       |
| 用户注册      | ✅ 已完成 | 包含表单验证和密码强度检测              |
| Token管理     | ✅ 已完成 | Access Token + Refresh Token 双令牌机制 |
| 自动Token刷新 | ✅ 已完成 | 透明刷新机制，无感续期                  |
| 登出功能      | ✅ 已完成 | 安全清除本地和远程会话                  |
| 持久化登录    | ✅ 已完成 | localStorage存储，页面刷新后保持登录    |

#### 2.1.2 UI/UX功能

| 功能项        | 实现状态  | 说明                       |
| ------------- | --------- | -------------------------- |
| 登录/注册切换 | ✅ 已完成 | 平滑动画过渡效果           |
| 实时表单验证  | ✅ 已完成 | 即时反馈输入合法性         |
| 密码强度检测  | ✅ 已完成 | 5项密码要求实时检测        |
| 加载状态动画  | ✅ 已完成 | 提交时的加载指示器         |
| 记住我        | ⚠️ UI占位 | 前端UI存在，需后端配合实现 |
| 忘记密码      | ⚠️ UI占位 | 仅前端按钮，功能未实现     |

#### 2.1.3 安全功能

| 功能项            | 实现状态  | 说明                           |
| ----------------- | --------- | ------------------------------ |
| 路由守卫          | ✅ 已完成 | ProtectedRoute组件保护私有路由 |
| 双重Token验证     | ✅ 已完成 | 状态+localStorage双重校验      |
| 自动清理过期Token | ✅ 已完成 | 检测到过期自动清理存储         |
| 登录后重定向      | ✅ 已完成 | 登录成功后回到原目标页面       |

#### 2.1.4 Web3钱包功能

| 功能项   | 实现状态  | 说明                     |
| -------- | --------- | ------------------------ |
| 钱包连接 | ✅ 已完成 | 支持MetaMask等主流钱包   |
| 钱包绑定 | ✅ 已完成 | 将钱包地址与用户账号关联 |
| 签名验证 | ✅ 已完成 | 通过签名验证钱包所有权   |

### 2.2 代码架构

```
src/
├── services/
│   └── auth.ts              # 认证API服务
├── store/
│   └── index.ts             # 认证状态管理 (Zustand)
├── hooks/
│   └── useAuth.ts           # 认证逻辑Hook
├── pages/
│   └── Auth/
│       └── index.tsx        # 登录页面
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx    # 登录表单
│   │   ├── RegisterForm.tsx # 注册表单
│   │   └── WalletBind.tsx   # 钱包绑定
│   └── routes/
│       └── ProtectedRoute.tsx  # 路由守卫
└── router.tsx               # 路由配置
```

---

## 3. 缺失功能清单

### 3.1 🔴 高优先级（建议立即开发）

#### 3.1.1 忘记密码功能

**现状**: UI存在"忘记密码？"按钮，但点击无响应  
**业务必要性**: ⭐⭐⭐⭐⭐  
**影响**: 用户无法找回密码，账号丢失风险

**详细需求**:

1. **前端页面**
   - 忘记密码入口页 (`/auth/forgot-password`)
   - 邮箱输入表单
   - 提交成功提示页
   - 重置密码页 (`/auth/reset-password?token=xxx`)
   - 新密码输入表单
   - 密码确认验证

2. **后端API需求**
   - `POST /auth/forgot-password` - 发送重置邮件
   - `GET /auth/verify-reset-token` - 验证Token有效性
   - `POST /auth/reset-password` - 重置密码

3. **交互流程**

   ```
   用户点击"忘记密码" → 输入邮箱 → 发送重置邮件
   → 用户查收邮件 → 点击链接 → 输入新密码 → 重置成功 → 跳转登录
   ```

4. **安全要求**
   - 重置Token有效期：30分钟
   - Token一次性使用
   - 邮件发送频率限制：每5分钟1次
   - 密码重置后强制登出所有设备

**预估工作量**: 1-2天

---

#### 3.1.2 邮箱验证功能

**现状**: 注册后无邮箱验证流程  
**业务必要性**: ⭐⭐⭐⭐  
**影响**: 无法确认邮箱真实性，垃圾账号风险

**详细需求**:

1. **验证流程**
   - 用户注册成功后发送验证邮件
   - 验证链接有效期：24小时
   - 未验证用户限制部分功能
   - 可重新发送验证邮件

2. **前端页面**
   - 验证提示组件（顶部横幅）
   - 验证成功/失败页面
   - 重新发送按钮（冷却时间：60秒）

3. **后端API需求**
   - `POST /auth/send-verification` - 发送验证邮件
   - `GET /auth/verify-email?token=xxx` - 验证邮箱
   - `GET /auth/verification-status` - 查询验证状态

4. **功能限制**
   - 未验证用户无法：
     - 创建企业
     - 绑定钱包
     - 发送邀请
   - 可正常：
     - 登录/登出
     - 查看公开内容

**预估工作量**: 1-2天

---

#### 3.1.3 "记住我"功能完善

**现状**: UI存在复选框，但仅前端保存，后端无配合  
**业务必要性**: ⭐⭐⭐  
**影响**: 用户体验不完整

**详细需求**:

1. **功能逻辑**
   - 勾选"记住我"：Refresh Token有效期延长至30天
   - 不勾选：Refresh Token有效期保持7天
   - 用户主动登出：立即清除所有Token

2. **前端实现**
   - 复选框状态传递到后端
   - 登录API添加 `remember_me` 参数

3. **后端API修改**
   - `POST /auth/login` 添加 `remember_me` 字段
   - 根据该字段设置Refresh Token过期时间

**预估工作量**: 0.5天

---

### 3.2 🟡 中优先级（建议近期开发）

#### 3.2.1 多因素认证(MFA)

**业务必要性**: ⭐⭐⭐⭐  
**安全级别**: 高  
**实现方式**: TOTP (基于时间的一次性密码)

**详细需求**:

1. **MFA开关**
   - 用户可在设置中开启/关闭MFA
   - 开启需要验证当前密码

2. **二维码绑定**
   - 生成TOTP密钥
   - 展示二维码（支持Google Authenticator等）
   - 提供手动输入密钥选项

3. **验证流程**
   - 登录时检查是否开启MFA
   - 如开启，跳转到MFA验证页
   - 输入6位动态验证码
   - 支持"记住此设备"（30天内免验证）

4. **恢复码**
   - 开启时生成10个一次性恢复码
   - 丢失认证器时使用恢复码登录
   - 使用后该码失效

**预估工作量**: 2-3天

---

#### 3.2.2 社交登录

**业务必要性**: ⭐⭐⭐  
**提升**: 注册转化率

**详细需求**:

1. **支持平台**
   - Google（优先）
   - GitHub（开发者友好）
   - 微信（国内用户）

2. **登录流程**
   - 点击社交登录按钮
   - 跳转到第三方授权页
   - 授权后回调到应用
   - 后端验证并创建/绑定账号
   - 登录成功

3. **账号绑定**
   - 已注册用户可绑定社交账号
   - 支持多社交账号绑定
   - 绑定后可用任一方式登录

4. **数据获取**
   - 获取用户基本信息（昵称、头像）
   - 不获取敏感信息
   - 用户可拒绝头像/昵称同步

**预估工作量**: 2-3天（每增加一个平台+1天）

---

#### 3.2.3 登录日志与设备管理

**业务必要性**: ⭐⭐⭐  
**安全审计**: 高

**详细需求**:

1. **登录日志**
   - 记录每次登录时间、IP、设备、地点
   - 登录成功/失败状态
   - 异常登录提醒

2. **设备管理**
   - 显示当前登录的所有设备
   - 可远程登出其他设备
   - 信任设备管理（免MFA）

3. **安全通知**
   - 新设备登录邮件通知
   - 异地登录提醒
   - 多次登录失败锁定

4. **日志查看**
   - 个人中心查看最近登录历史
   - 管理员后台查看全站登录统计

**预估工作量**: 2-3天

---

### 3.3 🟢 低优先级（后续迭代）

#### 3.3.1 单点登录(SSO)

- 企业内部系统集成
- 支持SAML/OIDC协议
- **预估工作量**: 3-5天

#### 3.3.2 生物识别登录

- 支持WebAuthn/FIDO2
- 指纹/面部识别（需设备支持）
- **预估工作量**: 2-3天

#### 3.3.3 登录页自定义

- 企业自定义品牌
- 自定义背景/Logo
- **预估工作量**: 1-2天

---

## 4. 开发优先级与时间规划

### 4.1 🔴 第一阶段（立即开发 - 本周）

| 功能       | 优先级     | 预估时间 | 依赖     |
| ---------- | ---------- | -------- | -------- |
| 忘记密码   | ⭐⭐⭐⭐⭐ | 1-2天    | 后端API  |
| 邮箱验证   | ⭐⭐⭐⭐   | 1-2天    | 邮件服务 |
| 记住我完善 | ⭐⭐⭐     | 0.5天    | 后端配合 |

**第一阶段总工作量**: 3-5天

### 4.2 🟡 第二阶段（近期开发 - 未来2周）

| 功能               | 优先级   | 预估时间 | 依赖       |
| ------------------ | -------- | -------- | ---------- |
| 多因素认证(MFA)    | ⭐⭐⭐⭐ | 2-3天    | 无         |
| 社交登录           | ⭐⭐⭐   | 2-3天    | 第三方平台 |
| 登录日志与设备管理 | ⭐⭐⭐   | 2-3天    | 后端日志   |

**第二阶段总工作量**: 6-9天

### 4.3 🟢 第三阶段（后续迭代 - 未来1个月）

- 单点登录(SSO)
- 生物识别登录
- 登录页自定义

**第三阶段总工作量**: 6-10天

---

## 5. 技术实现建议

### 5.1 忘记密码流程

```
┌─────────────┐    输入邮箱     ┌──────────────┐
│  忘记密码页  │ ──────────────→│  发送API请求  │
└─────────────┘                └──────────────┘
                                       │
                                       ↓
                              ┌──────────────┐
                              │ 后端生成Token │
                              │ 有效期30分钟  │
                              └──────────────┘
                                       │
                                       ↓
                              ┌──────────────┐
                              │  发送邮件    │
                              └──────────────┘
```

**API设计**:

```typescript
// 发送重置邮件
POST /auth/forgot-password
Request: { email: string }
Response: { success: boolean; message: string }

// 验证Token
GET /auth/verify-reset-token?token=xxx
Response: { valid: boolean; email?: string }

// 重置密码
POST /auth/reset-password
Request: { token: string; newPassword: string }
Response: { success: boolean }
```

### 5.2 邮箱验证流程

**建议方案**: 延迟验证（Grace Period）

- 用户注册后可立即使用基础功能
- 24小时内必须验证邮箱，否则限制功能
- 验证邮件可重复发送（冷却60秒）

**功能限制策略**:
| 功能 | 未验证用户 | 已验证用户 |
|------|-----------|-----------|
| 登录/登出 | ✅ 允许 | ✅ 允许 |
| 查看公开内容 | ✅ 允许 | ✅ 允许 |
| 创建企业 | ❌ 禁止 | ✅ 允许 |
| 绑定钱包 | ❌ 禁止 | ✅ 允许 |
| 发送邀请 | ❌ 禁止 | ✅ 允许 |

### 5.3 技术栈建议

**邮件服务**:

- 开发/测试: [ ethereal.email ](https://ethereal.email/)（免费测试邮箱）
- 生产环境: SendGrid / Amazon SES / 阿里云邮件推送

**MFA方案**:

- 推荐: TOTP (Time-based One-Time Password)
- 库: `speakeasy` (Node.js后端) + `qrcode` (生成二维码)
- 客户端: Google Authenticator / Microsoft Authenticator

**社交登录**:

- 推荐: Passport.js (Node.js) 或 自建OAuth流程
- 支持: Google (优先), GitHub, 微信

---

## 6. 验收标准

### 6.1 忘记密码功能

- [ ] 用户可通过邮箱接收重置链接
- [ ] 重置链接30分钟后失效
- [ ] Token只能使用一次
- [ ] 重置成功后旧密码失效
- [ ] 邮件发送频率限制（5分钟1次）
- [ ] 错误的Token友好提示

### 6.2 邮箱验证功能

- [ ] 注册后自动发送验证邮件
- [ ] 邮件发送冷却60秒
- [ ] 验证链接24小时有效
- [ ] 未验证用户功能限制生效
- [ ] 验证成功后即时解除限制
- [ ] 可重新发送验证邮件

### 6.3 "记住我"功能

- [ ] 勾选后Refresh Token有效期30天
- [ ] 不勾选时Refresh Token有效期7天
- [ ] 用户主动登出立即清除所有Token
- [ ] Token过期后需要重新登录

---

## 7. 附录

### 7.1 相关文档

- API接口文档: `/docs/api/auth.md`
- 前端路由配置: `/src/router.tsx`
- 状态管理: `/src/store/index.ts`

### 7.2 参考页面

- 登录页: `/auth`
- 忘记密码: `/auth/forgot-password` (待开发)
- 重置密码: `/auth/reset-password` (待开发)

### 7.3 开发团队

- 前端开发: [待分配]
- 后端开发: [待分配]
- UI/UX设计: [待分配]
- 测试: [待分配]

---

**文档更新历史**

| 版本 | 日期       | 更新内容                 | 作者         |
| ---- | ---------- | ------------------------ | ------------ |
| 1.0  | 2026-02-15 | 初始版本，梳理现状与需求 | AI Assistant |

---

**文档结束**

如需进一步细化某个功能的需求，请联系产品经理或开发团队负责人。
