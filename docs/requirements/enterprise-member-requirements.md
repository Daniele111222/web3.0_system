# 企业管理和成员邀请功能需求池

## 📋 需求概览

本文档整理了 Web3 IP-NFT 企业资产管理系统中**企业管理**和**成员邀请**相关功能的未闭环需求，按优先级和模块进行分类管理。

---

## 🔴 P0 - 高优先级（核心功能缺失）

### 1. 【邀请-1】完整的邮件邀请流程
**现状问题**：当前管理员输入邮箱直接添加成员，被添加者无需确认即刻成为成员，存在以下问题：
- 没有发送邮件邀请链接
- 没有"接受邀请/拒绝邀请"流程
- 没有邀请过期机制
- 被添加者可能根本不知道已被加入企业

**需求描述**：
- [ ] 创建 `EnterpriseInvitation` 数据模型，包含邀请码、过期时间、状态等字段
- [ ] 实现 `POST /enterprises/{id}/invitations` 发送邀请API
- [ ] 集成邮件服务（SendGrid/AWS SES），发送邀请邮件
- [ ] 实现 `GET /invitations/{token}` 验证邀请链接API
- [ ] 实现 `POST /invitations/{token}/accept` 接受邀请API
- [ ] 实现 `POST /invitations/{token}/reject` 拒绝邀请API
- [ ] 前端：创建邀请确认页面 `/invitation/{token}`
- [ ] 前端：邀请管理列表页面，支持查看、撤销、重新发送邀请
- [ ] 设置邀请过期时间（默认7天）

**验收标准**：
1. 管理员可以输入邮箱发送邀请
2. 被邀请人收到邮件并点击链接
3. 被邀请人可以接受或拒绝邀请
4. 接受后自动成为企业成员
5. 过期邀请无法使用

**相关模块**：后端API、前端UI、邮件服务

---

### 2. 【成员-1】成员主动退出企业功能
**现状问题**：当前成员无法主动退出企业，只能被管理员移除，缺乏自主性。

**需求描述**：
- [ ] 实现 `POST /enterprises/{id}/leave` 退出企业API
- [ ] 权限检查：普通成员可以直接退出；Owner需要先转让所有权才能退出
- [ ] 后端验证：Owner无法直接退出，需先指定新Owner
- [ ] 前端：在成员列表或个人设置中添加"退出企业"按钮
- [ ] 前端：退出前确认弹窗，提示"确定要退出该企业吗？"
- [ ] 退出后清理相关数据（成员关系、权限缓存等）

**验收标准**：
1. 成员可以点击退出企业按钮
2. 弹出确认对话框
3. 确认后成功退出企业
4. Owner退出前必须先转让所有权
5. 退出后不再看到该企业

**相关模块**：后端API、前端UI

---

### 3. 【成员-2】企业所有权转让功能
**现状问题**：当前没有企业所有权转让功能，Owner无法将所有权转移给其他成员。

**需求描述**：
- [ ] 实现 `POST /enterprises/{id}/transfer-ownership` 转让所有权API
- [ ] 权限检查：仅当前Owner可以发起转让
- [ ] 验证目标用户：必须是企业现有成员
- [ ] 转让流程：原Owner变为Admin，新Owner接手
- [ ] 记录转让历史：在审计日志中记录所有权变更
- [ ] 前端：在企业设置中添加"转让所有权"按钮
- [ ] 前端：选择新Owner的对话框（仅限企业成员）
- [ ] 前端：二次确认弹窗，提示所有权转让不可逆
- [ ] 转让后通知：通知新Owner和被降级的前Owner

**验收标准**：
1. Owner可以发起所有权转让
2. 只能选择现有成员作为新Owner
3. 转让后原Owner变为Admin
4. 转让记录在审计日志中
5. 新Owner获得完整控制权

**相关模块**：后端API、前端UI、审计日志

---

## 🟡 P1 - 中优先级（功能增强）

### 4. 【邀请-2】用户主动申请加入企业
**现状问题**：当前用户只能被管理员邀请加入企业，无法主动申请加入感兴趣的企业。

**需求描述**：
- [ ] 创建 `EnterpriseJoinRequest` 数据模型，记录申请信息
- [ ] 实现 `GET /enterprises/search` 搜索公开企业API（支持按名称、行业筛选）
- [ ] 实现 `POST /enterprises/{id}/join-requests` 提交加入申请API
- [ ] 支持申请时填写申请理由
- [ ] 实现 `GET /enterprises/{id}/join-requests` 查看申请列表API（仅Admin/Owner）
- [ ] 实现 `POST /join-requests/{id}/approve` 审批通过API
- [ ] 实现 `POST /join-requests/{id}/reject` 审批拒绝API
- [ ] 实现 `GET /my/join-requests` 查看我的申请记录API
- [ ] 前端：创建"发现企业"页面，支持搜索和浏览公开企业
- [ ] 前端：企业详情页添加"申请加入"按钮
- [ ] 前端：申请对话框（填写申请理由）
- [ ] 前端：企业管理后台-加入申请管理页面
- [ ] 通知：申请提交、审批结果实时通知

**验收标准**：
1. 用户可以搜索并浏览公开企业
2. 用户可以提交加入申请
3. 企业管理员可以看到待审批的申请
4. 管理员可以通过或拒绝申请
5. 申请人收到审批结果通知

**相关模块**：后端API、前端UI、搜索服务、通知系统

---

### 5. 【审批-1】邀请成员时触发审批流程
**现状问题**：当前邀请成员时直接添加，未触发审批流程，企业的`requireApproval`设置未生效。

**需求描述**：
- [ ] 修改 `invite_member` 方法，检查企业的 `requireApproval` 设置
- [ ] 如果 `requireApproval=true`，创建审批申请而非直接添加成员
- [ ] 审批类型：`MEMBER_INVITE`，子类型：`invite`
- [ ] 审批内容包括：被邀请人邮箱、角色、邀请人信息
- [ ] 实现审批通过后的回调：自动添加成员到企业
- [ ] 实现审批拒绝后的回调：发送拒绝通知给邀请人
- [ ] 前端：邀请对话框提示"该企业需要审批，邀请将提交审批"
- [ ] 前端：审批管理页面显示成员邀请类型的审批
- [ ] 通知：邀请提交、审批结果通知相关方

**验收标准**：
1. 邀请成员时检查企业设置
2. 如需审批则创建审批申请
3. 审批通过后自动添加成员
4. 审批拒绝通知邀请人
5. 无需审批时直接添加成员

**相关模块**：后端API、审批流程、前端UI

---

### 6. 【成员-3】成员权限批量管理
**现状问题**：当前成员管理是单个操作，无法批量更新角色或批量移除成员，效率低下。

**需求描述**：
- [ ] 实现 `POST /enterprises/{id}/members/batch-update` 批量更新角色API
- [ ] 实现 `POST /enterprises/{id}/members/batch-remove` 批量移除成员API
- [ ] 支持选择多个成员进行批量操作
- [ ] 批量操作权限检查：仅Owner/Admin可操作，不能包含Owner
- [ ] 事务处理：批量操作要么全部成功，要么全部失败
- [ ] 前端：成员列表添加复选框，支持全选/反选
- [ ] 前端：批量操作工具栏（批量改角色、批量移除）
- [ ] 前端：批量操作确认对话框，显示操作影响和确认提示
- [ ] 操作记录：批量操作记录到审计日志

**验收标准**：
1. 可以选择多个成员
2. 批量更新角色成功
3. 批量移除成员成功
4. 操作前确认提示
5. 操作记录到日志

**相关模块**：后端API、前端UI、审计日志

---

## 🟢 P2 - 低优先级（体验优化）

### 7. 【邀请-3】邀请链接/邀请码功能
**现状问题**：当前只能通过邮箱邀请，没有更灵活的邀请方式如邀请链接或邀请码。

**需求描述**：
- [ ] 创建 `EnterpriseInviteLink` 数据模型
- [ ] 实现 `POST /enterprises/{id}/invite-links` 创建邀请链接API
- [ ] 支持设置邀请链接有效期、最大使用次数、默认角色
- [ ] 实现 `GET /invite-links/{code}` 验证邀请链接API
- [ ] 实现 `POST /invite-links/{code}/join` 通过链接加入API
- [ ] 实现 `GET /enterprises/{id}/invite-links` 获取链接列表API
- [ ] 实现 `DELETE /invite-links/{id}` 删除邀请链接API
- [ ] 前端：企业设置页添加"邀请链接"管理模块
- [ ] 前端：创建邀请链接对话框（设置有效期、使用次数、角色）
- [ ] 前端：邀请链接列表，支持复制链接、查看统计、删除
- [ ] 前端：邀请链接加入页面 `/join/{code}`，展示企业信息并确认加入

**验收标准**：
1. 可以创建邀请链接
2. 可以设置有效期和使用次数
3. 用户可以通过链接加入
4. 可以管理和删除链接
5. 过期或达上限链接不可用

**相关模块**：后端API、前端UI

---

### 8. 【成员-4】成员活跃度统计
**现状问题**：当前没有成员活跃度统计，无法了解成员参与情况。

**需求描述**：
- [ ] 创建成员活跃度统计表或增加统计字段
- [ ] 记录成员登录次数、最后登录时间
- [ ] 记录成员操作次数（资产创建、审批参与等）
- [ ] 实现 `GET /enterprises/{id}/members/statistics` 获取统计API
- [ ] 支持按时间范围筛选（本周、本月、本季度）
- [ ] 支持导出统计数据为Excel
- [ ] 前端：成员列表添加活跃度展示（最后登录、操作次数）
- [ ] 前端：成员活跃度统计页面，包含图表和数据表
- [ ] 前端：支持筛选和导出功能

**验收标准**：
1. 可以查看成员活跃度
2. 包含登录次数、操作次数等
3. 支持时间筛选
4. 可以导出统计
5. 图表展示直观

**相关模块**：后端API、前端UI、数据统计

---

### 9. 【通用-1】审计日志功能完善
**现状问题**：当前缺乏完善的审计日志功能，无法追踪重要操作。

**需求描述**：
- [ ] 创建 `AuditLog` 数据模型，记录所有重要操作
- [ ] 记录字段：操作用户、操作类型、操作对象、操作时间、IP地址、操作详情
- [ ] 实现审计日志装饰器，自动记录API操作
- [ ] 实现 `GET /audit-logs` 查询审计日志API（仅Admin/Owner）
- [ ] 支持按用户、操作类型、时间范围筛选
- [ ] 支持导出审计日志为Excel/CSV
- [ ] 前端：审计日志页面，支持筛选、搜索、导出
- [ ] 前端：企业设置中添加"审计日志"入口（仅Admin/Owner可见）

**验收标准**：
1. 所有重要操作都有日志记录
2. 可以查询和筛选日志
3. 可以导出日志
4. 仅管理员可查看
5. 日志包含完整操作信息

**相关模块**：后端API、前端UI、审计系统

---

## 📊 需求统计

| 优先级 | 需求数量 | 关键需求 |
|--------|----------|----------|
| P0 - 高 | 3个 | 邮件邀请流程、成员退出、所有权转让 |
| P1 - 中 | 3个 | 主动申请加入、邀请审批、批量管理 |
| P2 - 低 | 3个 | 邀请链接、活跃度统计、审计日志 |

---

## 🔄 版本规划建议

### v1.1（近期）- 补齐核心闭环
- 完成 P0 优先级所有需求（邀请流程、退出功能、所有权转让）

### v1.2（中期）- 功能增强
- 完成 P1 优先级需求（主动申请、审批流程、批量管理）

### v1.3（远期）- 体验优化
- 完成 P2 优先级需求（邀请链接、统计、审计日志）

---

## 📝 附录

### A. 相关技术文档
- 后端API文档：`/docs` (Swagger UI)
- 数据库模型：`backend/app/models/`
- 接口定义：`frontend/src/types/`

### B. 相关代码文件

**后端：**
- `backend/app/api/v1/enterprises.py` - 企业API
- `backend/app/services/enterprise_service.py` - 企业业务逻辑
- `backend/app/models/enterprise.py` - 企业数据模型

**前端：**
- `frontend/src/pages/Enterprise/` - 企业页面
- `frontend/src/components/enterprise/` - 企业组件
- `frontend/src/services/enterprise.ts` - 企业服务

---

**文档版本**：v1.0  
**最后更新**：2026-02-17  
**维护者**：开发团队
